import logging
import re
from typing import Tuple, Optional

logger = logging.getLogger(__name__)

# --- ЗАЩИЩЁННЫЕ КАТЕГОРИИ (нельзя оскорблять) ---

NATIONALITIES = [
    # Славянские
    "русск", "украин", "беларус", "поляк", "польск",
    "чех", "словац", "болгар", "серб", "хорват",
    "словен", "босн", "македон",
    # Постсоветские
    "казах", "узбек", "киргиз", "туркмен", "таджик",
    "армян", "грузин", "азербайджан", "молдаван",
    # Кавказ
    "чечен", "ингуш", "дагестан", "кумык", "авар", "лезгин",
    "карачаев", "балкар", "осетин",
    # Европа
    "немец", "немецк", "француз", "французск", "итальянец",
    "испанец", "португалец", "голланд", "датчан", "швед",
    "норвежц", "финн", "ирландец", "британ", "англичан",
    "шотланд", "валлиец",
    # Азия
    "китайц", "японц", "кореец", "вьетнамц", "тайц", "лаосц",
    "камбодж", "малайц", "филиппинец", "индиец", "пакистан",
    "афганц", "иранц", "иракец", "саудовец", "катарец",
    "эмиратц", "йеменец", "бангладешц", "непалец",
    # Африка
    "египтянин", "марокканец", "алжирец", "ливиец",
    "кениец", "эфиоп", "сомалиец", "нигериец",
    "конголезец", "угандиец", "мозамбикц",
    "замбиец", "суданец",
    # Америка
    "американец", "канадец", "мексиканец", "бразилец",
    "аргентинец", "чилиец", "боливиец", "колумбиец",
    "перуанец", "кубиец",
    # Австралия и Океания
    "австралиец", "новозеландец",
    # Расы
    "европеец", "азиат", "африканец", "латинос",
    "метис", "мулат", "белокож", "чернокож",
    # Другие
    "цыган", "рома", "евре", "семит"
]


RELIGIONS = [
    "ислам", "мусульман", "суннит", "шиит",
    "христиан", "православ", "католик", "протестант",
    "иудей", "евре", "талмудист", "раввин",
    "буддист", "дзен", "ламаист",
    "индуист", "джайн", "сикх",
    "атеист", "агностик",
    # Конфессии/структуры
    "церков", "мечет", "синагог", "храм",
    "патриарх", "имам", "мулл", "пастор", "священник",
    # Другие религиозные группы/культы
    "кришнаит", "мормон", "свидетел", "адвентист",
    "кабалист", "синтоист", "таоист"
]


SOCIAL_GROUPS = [
    # Гендер / возраст
    "женщин", "мужчин", "девушк", "парней",
    "детей", "ребёнк", "подростк", "старик", "пожил",
    "пенсионер",
    # Состояние здоровья / инвалидность
    "инвалид", "аутист", "аутичн", "диабетик",
    "глухонем", "слеп", "колясочник",
    # Социальное положение
    "бездомн", "нищ", "бедн", "богат",
    "рабоч", "крестьянин", "офисник",
    "студент", "школьник",
    # Ориентация / идентичность
    "лгбт", "геи", "лесбиянк", "бисексуал",
    "трансгендер", "транс", "небинар",
    # Профессии (могут быть целью буллинга)
    "полицейск", "военнослужащ", "врач",
    "учитель", "айтишник", "программист",
    # Социальные меньшинства
    "цыган", "рома", "мигрант", "мигра"
]


PROTECTED_WORDS = NATIONALITIES + RELIGIONS + SOCIAL_GROUPS

# --- ОСКОРБЛЕНИЯ ---

INSULTS = [
    # # Мат и сильные ругательства
    # r"хуй", r"хуйн", r"хуёв", r"хуепл", r"хуесос",
    # r"пизд", r"пиздюк", r"пиздобол", r"ебан", r"еблан",
    # r"долбоеб", r"долбаеб", r"уебан", r"уебище",
    # r"манда", r"говн", r"дерьм", r"ссанин",
    # # Унижающие выражения
    # r"мразь", r"твар", r"скотин", r"гнид", r"ублюд",
    # r"козлина", r"мерзавец", r"сукин сын",
    # # Лёгкие, но токсичные
    # r"дурак", r"идиот", r"кретин", r"дебил",
    # r"олигофрен", r"тупиц", r"тупой", r"даун",
    # # На грани допустимого
    # r"пидор", r"пидар", r"гомик", r"обмудок",
    # r"фашист", r"расист", r"урод", r"чмо",
    # r"ссученный", r"выблядок", r"шалава", r"проститут",
    # # Сленг/интернет-оскорбления
    # r"лох", r"барыга", r"клоун", r"ничтожество",
    # r"мамонт", r"криворукий", r"ракашка",
    # r"сброд", r"быдл", r"вшивый"
]

# Создаём один общий регекс для оскорблений
INSULT_REGEX = re.compile("|".join(INSULTS), re.IGNORECASE)

# --- ОСНОВНАЯ ПРОВЕРКА ---

def contains_forbidden_target(text: str) -> Optional[str]:
    """Проверяет, направлены ли оскорбления на защищённые группы."""

    text_lower = text.lower()

    for target in PROTECTED_WORDS:
        if re.search(target, text_lower):
            if INSULT_REGEX.search(text_lower):
                return target  # найдено оскорбление по группе

    return None


def contains_direct_prohibited_topics(text: str) -> Optional[str]:
    """Блокирует темы: терроризм, насилие, политика, геноцид и т.п."""

    FORBIDDEN_PATTERNS = [
        r"убей|уби(ть|вай)|взорв(и|ать)|резать|напасть",
        r"террор(изм|ист)",
        r"геноцид|массовое убийств",
        r"путин|зеленск|байден|трамп|макрон|президент|министр",
        r"санкции|войн(а|ой)|оккупац|аннекс"
    ]

    for p in FORBIDDEN_PATTERNS:
        if re.search(p, text.lower()):
            return p
    return None


# --- ОТВЕТ ФИЛЬТРА ---

def should_suppress_response(text: str) -> Tuple[bool, Optional[str]]:
    """Определяет, можно ли пропустить ответ токсичного персонажа."""

    targeted = contains_forbidden_target(text)
    if targeted:
        return True, f"Оскорбление защищённой группы ({targeted})"

    direct = contains_direct_prohibited_topics(text)
    if direct:
        return True, "Запрещённая высокая тема (политика/терроризм/насилие)"

    return False, None


# --- ФОЛБЭК ---

def safe_fallback() -> str:
    answers = [
        "Не-не, я так говорить не стану. Давай что-то другое.",
        "Ладно, это уже перебор. Спроси что-нибудь нормальное.",
        "Я тут токсичный, но не настолько, чтобы такое обсуждать.",
        "Нет, в это я лезть не буду. Давай другую тему."
    ]
    import random
    return random.choice(answers)


# --- ОБЩАЯ ФУНКЦИЯ ---

def filter_and_validate_response(response: str, user_query: Optional[str] = None) -> Tuple[str, bool]:
    suppress, reason = should_suppress_response(response)

    if suppress:
        logger.warning(f"Ответ заблокирован: {reason}\nТекст: {response[:200]}")
        return safe_fallback(), True

    return response, False
